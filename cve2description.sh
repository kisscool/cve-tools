#!/bin/sh
# vim: set softtabstop=2 shiftwidth=2 expandtab :
# (c) 2020 KissCool

# Usage : cve2description.sh cve_without_description.txt

# robustify the script
topdir=`dirname "$(realpath $0)"`

format="%-30s\t%-75s\t%-20s\t%s\t%s\t%s\n"

awk '
  BEGIN {
    # input and output use tabulations, and define a file header
    FS = OFS = "\t";
    printf "'$format'", "Package", "CPE", "CVE", "CVSS", "Assessment", "Description";
  }

  # skip the files headers
  FNR <= 1 { next }

  # FNR and NR are equal only for the first file
  # we populate an associative array of CVE --> Descriptions from the NVD
  # database to speed-up processing
  FNR==NR && /:/ {
    FS = "\": ";
    split($1,tmp1,"\"");
    split($2,tmp2,"\"");
    cve[tmp1[2]] = tmp2[2];
    next;
  }
  FNR==NR && !/:/ {
    next;
  }

  # executed only for the second file
  {
    # get back to standard tabulations as input separator
    FS = "\t";
    # sanitize the CVE identifier in case of dirty input
    gsub(/ /, "", $3);
    # check if a description already exist
    if (! $6) {
      $6 = cve[$3];
    } 
    # initialize the assesment if needed
    if (! $5) { 
      $5 = 0;
    }
    printf "'$format'", $1, $2, $3, $4, $5, $6;
  }
  END {}
' "${topdir}"/nvd/cve_redux.json $1 

