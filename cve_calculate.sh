#!/bin/sh
# vim: set softtabstop=2 shiftwidth=2 expandtab :
# (c) 2022 KissCool

# Usage : cve_calculate.sh cve_with_cvss_strings.txt

# robustify the script
topdir=`dirname "$(realpath $0)"`

awk '
  BEGIN {
    # input and output use tabulations, and define a file header
    FS = OFS = "\t";
    print "Package", "CPE", "CVE", "Base_score", "Base_vector", "Env_vector", "Final_score", "Description";
  }

  # skip the files headers
  FNR <= 1 { next }

  // {
    # init variables for easier handling
    base_vector=$5
    env_vector=$6
    final_vector=$5"/"$6
    # do calculations
    #Â we need to close the pipes after usage or we end up with ghost data
    base_cmd="'"${topdir}"'/cvss.sh "base_vector
    base_cmd | getline base_score
    close(base_cmd)
    final_cmd="'"${topdir}"'/cvss.sh "final_vector
    final_cmd | getline final_score
    close(final_cmd)
    # check if the results are numerics (or otherwise error strings)
    if (base_score+0 != base_score) { base_score=0 }
    if (final_score+0 != final_score) { final_score=0 }

    print $1, $2, $3, base_score, $5, $6, final_score, $8;
  }
  END {}
' $1

