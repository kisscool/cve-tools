#!/bin/sh
# vim: set softtabstop=2 shiftwidth=2 expandtab :
# (c) 2019 KissCool

# Usage : cve_compare.sh cve_20190521_anotated.txt cve_20190630_raw.txt

format="%-30s\t%-75s\t%-20s\t%s\t%s\t%s\n"

awk '
  BEGIN {
    # input and output use tabulations, plus define a file header
    FS = OFS = "\t";
    printf "'$format'", "Pakage", "CPE", "CVE", "CVSS", "Assessment", "Description";
  }

  # skip the files headers
  FNR <= 1 { next }  
 
  # FNR and NR are equal only for the first file
  # we populate an array of CVE --> Assesment
  # we also populate an array of CVE --> Description to speed-up processing
  FNR==NR{
    gsub(/ /, "", $3);
    cve_assesment[$3] = $5;
    cve_description[$3] = $6;
    next;
  }
  
  # executed only for the second file
  {
    # we define a default Assesment if it doesnt exist yet
    if (! cve_assesment[$3]) { cve_assesment[$3] = 0 };
    printf "'$format'", $1, $2, $3, $4, cve_assesment[$3], cve_description[$3];
  }

  END {}
' $1 $2
